<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR LUDO | My Wallet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #040913; --card: #0d1b33; --card-2: #102340; --text: #e8efff;
      --muted: #9fb0d1; --line: rgba(255,255,255,.08); --gold-1: #a86b00; --gold-2: #ffd05a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', sans-serif; color: var(--text); background: radial-gradient(1200px 500px at 50% -200px, #154b99 0%, var(--bg) 65%); }
    .app { max-width: 540px; margin: 0 auto; min-height: 100vh; border-left: 1px solid rgba(255,255,255,.05); border-right: 1px solid rgba(255,255,255,.05); padding-bottom: 24px; }
    .header { position: sticky; top: 0; z-index: 20; backdrop-filter: blur(8px); background: rgba(4,9,19,.88); border-bottom: 1px solid var(--line); display: flex; align-items: center; justify-content: space-between; padding: 12px; }
    .icon-btn { border: 1px solid var(--line); background: rgba(255,255,255,.04); color: var(--text); border-radius: 10px; width: 38px; height: 38px; display: grid; place-items: center; text-decoration: none; cursor: pointer; }
    .title { font-weight: 800; letter-spacing: .8px; }
    .content { padding: 14px; }
    .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .wallet-card { border: 1px solid var(--line); border-radius: 14px; padding: 13px; min-height: 110px; box-shadow: 0 14px 30px rgba(0,0,0,.35); }
    .cash { background: linear-gradient(130deg, #0f49b3, #2a89ff); }
    .win { background: linear-gradient(130deg, var(--gold-1), var(--gold-2)); color: #21180f; }
    .wallet-card p { margin: 0; font-size: 12px; opacity: .9; }
    .wallet-card h2 { margin: 8px 0 0; font-size: 28px; }
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .btn { border: 0; border-radius: 12px; padding: 12px; font-weight: 700; color: #fff; cursor: pointer; }
    .btn-add { background: linear-gradient(110deg, #0e9245, #31cb75); }
    .btn-withdraw { background: linear-gradient(110deg, #d24a13, #ff874a); }
    .tabs { margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .tab { border: 1px solid var(--line); border-radius: 10px; background: rgba(255,255,255,.03); color: var(--text); padding: 10px; cursor: pointer; font-weight: 600; text-align: center; }
    .tab.active { background: rgba(47,123,255,.25); border-color: rgba(47,123,255,.6); }
    .list { margin-top: 10px; }
    .panel { border: 1px solid var(--line); border-radius: 14px; padding: 12px; background: linear-gradient(160deg, var(--card), var(--card-2)); box-shadow: 0 14px 30px rgba(0,0,0,.35); }
    .item { border: 1px solid var(--line); border-radius: 11px; background: rgba(255,255,255,.02); padding: 10px; margin-bottom: 8px; font-size: 12px; }
    .muted { color: var(--muted); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); z-index: 35; display: none; }
    .overlay.show { display: block; }
    .modal { position: fixed; z-index: 40; left: 50%; top: 50%; transform: translate(-50%,-50%); width: min(92%, 460px); border: 1px solid var(--line); border-radius: 14px; background: #09182f; padding: 14px; display: none; }
    .modal.show { display: block; }
    .input { width: 100%; border: 1px solid var(--line); background: rgba(255,255,255,.03); color: var(--text); border-radius: 10px; padding: 11px; margin-top: 8px; outline: none; }
    .sidebar { position: fixed; inset: 0 auto 0 0; width: 78%; max-width: 320px; background: #09172d; border-right: 1px solid var(--line); z-index: 50; transform: translateX(-100%); transition: transform .24s ease; padding: 16px; }
    .sidebar.open { transform: translateX(0); }
    .menu-link { display: block; color: var(--text); text-decoration: none; border: 1px solid var(--line); padding: 10px; border-radius: 10px; margin-bottom: 8px; background: rgba(255,255,255,.03); }
    .method-btn.active { border-color: #fff; background: rgba(47,123,255,.35); }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <a class="icon-btn" href="index.html">←</a>
      <div class="title">MY WALLET</div>
      <button class="icon-btn" id="menuBtn">☰</button>
    </header>

    <main class="content">
      <section class="cards">
        <article class="wallet-card cash"><p>Deposit Cash</p><h2 id="cashBal">₹0</h2></article>
        <article class="wallet-card win"><p>Winnings</p><h2 id="winBal">₹0</h2></article>
      </section>

      <section class="actions">
        <button id="addCashBtn" class="btn btn-add">ADD CASH</button>
        <button id="withdrawBtn" class="btn btn-withdraw">WITHDRAW</button>
      </section>

      <section class="panel" style="margin-top:12px;">
        <h3>Refer & Earn</h3>
        <div class="cards" style="grid-template-columns:1fr 1fr 1fr; gap:8px;">
          <article class="wallet-card" style="min-height:88px;background:rgba(47,123,255,.15);"><p>Total Refers</p><h2 id="totalRefers" style="font-size:20px;">0</h2></article>
          <article class="wallet-card" style="min-height:88px;background:rgba(255,208,90,.15);"><p>Total Earned</p><h2 id="totalEarned" style="font-size:20px;">₹0</h2></article>
          <article class="wallet-card" style="min-height:88px;background:rgba(56,209,127,.15);"><p>Referral Wallet</p><h2 id="referralWallet" style="font-size:20px;">₹0</h2></article>
        </div>
        <button id="withdrawReferralBtn" class="btn btn-add" style="margin-top:10px; width:100%;">Withdraw Commission to Cash</button>
      </section>

      <section class="tabs">
        <button class="tab active" data-tab="deposit">Deposit History</button>
        <button class="tab" data-tab="withdraw">Withdraw History</button>
      </section>
      <section class="list" id="historyList"></section>
    </main>
  </div>

  <aside id="sidebar" class="sidebar">
    <h4>SR LUDO Menu</h4>
    <a href="index.html" class="menu-link">Home</a>
    <a href="wallet.html" class="menu-link">Wallet</a>
    <a href="profile.html" class="menu-link">Profile</a>
    <a href="#" class="menu-link" id="logoutBtn">Logout</a>
  </aside>

  <div class="overlay" id="overlay"></div>

  <section class="modal" id="depositModal">
    <h3>Add Cash</h3>
    <img src="qr.png" style="width:180px; display:block; margin:auto; border-radius:10px;" />
    <input class="input" id="depositAmount" type="number" placeholder="Enter amount" />
    <input class="input" id="utrInput" placeholder="Enter UTR/Transaction ID" />
    <input class="input" type="file" id="depositSS" accept="image/*" />
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button id="submitDepositBtn" class="btn btn-add" style="flex:1;">Submit</button>
      <button class="btn" style="background:#444;" data-close-modal="depositModal">Close</button>
    </div>
  </section>

  <section class="modal" id="withdrawModal">
    <h3>Withdraw Winnings</h3>
    <div style="display:flex; gap:8px;">
      <button id="methodUpiBtn" class="btn method-btn active" style="flex:1; background:#222; border:1px solid #444;">UPI</button>
      <button id="methodBankBtn" class="btn method-btn" style="flex:1; background:#222; border:1px solid #444;">Bank</button>
    </div>
    <div id="withdrawMethodInfo" style="margin-top:10px; font-size:12px; color:var(--muted);"></div>
    <input class="input" id="withdrawAmount" type="number" placeholder="Min ₹100" />
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button id="submitWithdrawBtn" class="btn btn-withdraw" style="flex:1;">Submit Request</button>
      <button class="btn" style="background:#444;" data-close-modal="withdrawModal">Close</button>
    </div>
  </section>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getDatabase, ref, get, set, push, onValue, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyAx0fr47IsOtBxakcBj1ndwDYle_XlaE-Y',
    authDomain: 'sr-ludo-4440b.firebaseapp.com',
    databaseURL: 'https://sr-ludo-4440b-default-rtdb.firebaseio.com',
    projectId: 'sr-ludo-4440b',
    storageBucket: 'sr-ludo-4440b.firebasestorage.app',
    messagingSenderId: '1080387235822',
    appId: '1:1080387235822:web:77faea231641837950e8ff'
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const IMGBB_API_KEY = 'ca44783bda6779b5e3913432bd243b30';

  // Global variables
  let userData = {};
  let activeTab = 'deposit';
  let currentMethod = 'UPI';
  let phone = ""; // Ye niche auto-fill hoga

  const cashBal = document.getElementById('cashBal');
  const winBal = document.getElementById('winBal');
  const historyList = document.getElementById('historyList');
  const referralWallet = document.getElementById('referralWallet');
  const totalEarned = document.getElementById('totalEarned');
  const totalRefers = document.getElementById('totalRefers');
  const withdrawMethodInfo = document.getElementById('withdrawMethodInfo');

  const fmt = (v = 0) => `₹${Number(v || 0).toLocaleString('en-IN')}`;
  const showModal = (id) => { document.getElementById(id).classList.add('show'); document.getElementById('overlay').classList.add('show'); };
  const closeModal = (modal) => { modal.classList.remove('show'); document.getElementById('overlay').classList.remove('show'); };

  // --- AUTH CHECK: Sab kuch iske andar hona chahiye ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const userEmailPrefix = user.email.split('@')[0];
      phone = userEmailPrefix.length === 10 ? "+91" + userEmailPrefix : userEmailPrefix;
      localStorage.setItem('sr_ludo_phone', phone);
      
      console.log("Authenticated as:", phone);
      startAppLogic(); // Pura logic yahan se shuru hoga
    } else {
      window.location.href = 'index.html';
    }
  });

  function startAppLogic() {
    // 1. User Balance Load Karein
    onValue(ref(db, `users/${phone}`), (snap) => {
      userData = snap.val() || {};
      cashBal.textContent = fmt(userData.balance);
      winBal.textContent = fmt(userData.win_balance);
      referralWallet.textContent = fmt(userData.referral_balance);
      totalEarned.textContent = fmt(userData.referral_earnings_total);
      renderWithdrawMethodInfo();
    });

    // 2. Referrals Load Karein
    onValue(ref(db, `referrals/${phone}`), (snap) => {
      totalRefers.textContent = Object.keys(snap.val() || {}).length;
    });

    // 3. History Load Karein
    loadHistory();
  }

  // --- BAKI FUNCTIONS (History, Withdraw, Deposit) ---
  const renderHistory = (records) => {
    if (!records.length) { historyList.innerHTML = '<div class="item muted">No records found.</div>'; return; }
    historyList.innerHTML = records.map(r => {
      const status = (r.status || 'pending').toLowerCase();
      const color = status === 'approved' ? '#38d17f' : (status === 'rejected' ? '#ff3d4d' : '#ffb34a');
      return `<div class="item" style="border-left: 4px solid ${color}; background:rgba(255,255,255,0.02); padding:10px; margin-bottom:8px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between;">
                  <strong>${fmt(r.amount)}</strong>
                  <span style="color:${color}; font-weight:800; text-transform:uppercase; font-size:10px;">${status}</span>
                </div>
                <div class="muted" style="font-size:11px; margin-top:5px;">${new Date(r.time).toLocaleString('en-IN')}</div>
              </div>`;
    }).join('');
  };

  const loadHistory = async () => {
    const path = activeTab === 'deposit' ? 'deposit_requests' : 'withdraw_requests';
    const snap = await get(ref(db, path));
    const all = snap.val() || {};
    const filtered = Object.values(all).filter(i => i && i.phone === phone).sort((a,b) => (b.time || 0) - (a.time || 0));
    renderHistory(filtered);
  };

  const renderWithdrawMethodInfo = () => {
    if (currentMethod === 'UPI') {
      withdrawMethodInfo.innerHTML = userData.upi_id ? `UPI: ${userData.upi_id}` : '<span style="color:red">Profile mein UPI update karein!</span>';
    } else {
      withdrawMethodInfo.innerHTML = userData.bank_acc ? `A/C: ${userData.bank_acc}<br>IFSC: ${userData.bank_ifsc}` : '<span style="color:red">Profile mein Bank details dalein!</span>';
    }
  };

  // Buttons Click Handlers
// Referral Commission ko Cash Wallet mein bhejne ka logic
document.getElementById('withdrawReferralBtn').onclick = async () => {
    // Check karein ki referral wallet mein paisa hai bhi ya nahi
    const amountToMove = Number(userData.referral_balance || 0);

    if (amountToMove <= 0) {
        return alert('Referral wallet mein balance nahi hai!');
    }

    if (!confirm(`Kya aap ₹${amountToMove} apne cash wallet mein transfer karna chahte hain?`)) {
        return;
    }

    try {
        const userRef = ref(db, `users/${phone}`);
        
        // Transaction chalao taki referral se minus ho aur balance mein plus ho
        const tx = await runTransaction(userRef, (user) => {
            if (user) {
                const comm = Number(user.referral_balance || 0);
                if (comm > 0) {
                    // Referral se balance mein paisa shift karo
                    user.balance = (user.balance || 0) + comm;
                    user.referral_balance = 0; // Referral wallet khali kar do
                }
            }
            return user;
        });

        if (tx.committed) {
            alert('Success! Commission aapke Cash Wallet mein bhej diya gaya hai.');
        } else {
            alert('Transfer fail ho gaya. Kripya dobara koshish karein.');
        }
    } catch (error) {
        console.error("Transfer Error:", error);
        alert('Error: ' + error.message);
    }
};
  document.getElementById('addCashBtn').onclick = () => showModal('depositModal');
  document.getElementById('withdrawBtn').onclick = () => { renderWithdrawMethodInfo(); showModal('withdrawModal'); };
  document.getElementById('submitWithdrawBtn').onclick = async () => {
    const amount = Number(document.getElementById('withdrawAmount').value);
    if (userData.kyc_status !== 'verified') return alert('Pehle KYC verify karein!');
    if (!amount || amount < 100) return alert('Min ₹100');
    
    try {
      const userRef = ref(db, `users/${phone}`);
      const tx = await runTransaction(userRef, (user) => {
        if (!user) return user;
        if ((user.win_balance || 0) < amount) return;
        user.win_balance -= amount;
        return user;
      });
      if (!tx.committed) throw new Error('Balance kam hai!');
      
      const reqRef = push(ref(db, 'withdraw_requests'));
      await set(reqRef, { id: reqRef.key, phone, amount, status: 'pending', time: Date.now(), method: currentMethod });
      alert('Request Sent!'); closeModal(document.getElementById('withdrawModal')); loadHistory();
    } catch(e) { alert(e.message); }
  };

  document.getElementById('submitDepositBtn').onclick = async () => {
    const amount = Number(document.getElementById('depositAmount').value);
    const utr = document.getElementById('utrInput').value.trim();
    const file = document.getElementById('depositSS').files[0];
    if (!amount || !utr || !file) return alert('Fill all!');

    try {
      const fd = new FormData(); fd.append('image', file);
      const resp = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
      const json = await resp.json();
      const reqRef = push(ref(db, 'deposit_requests'));
      await set(reqRef, { id: reqRef.key, phone, amount, utr, screenshot: json.data.url, status: 'pending', time: Date.now() });
      alert('Submitted!'); closeModal(document.getElementById('depositModal')); loadHistory();
    } catch(e) { alert('Failed'); }
  };

  // UI Navigation
  document.getElementById('methodUpiBtn').onclick = () => { currentMethod = 'UPI'; renderWithdrawMethodInfo(); };
  document.getElementById('methodBankBtn').onclick = () => { currentMethod = 'Bank'; renderWithdrawMethodInfo(); };
  document.querySelectorAll('.tab').forEach(t => t.onclick = () => { 
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); 
    t.classList.add('active'); activeTab = t.dataset.tab; loadHistory(); 
  });
  document.querySelectorAll('[data-close-modal]').forEach(b => b.onclick = () => closeModal(document.getElementById(b.dataset.closeModal)));
  document.getElementById('menuBtn').onclick = () => { document.getElementById('sidebar').classList.add('open'); document.getElementById('overlay').classList.add('show'); };
  document.getElementById('overlay').onclick = () => { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); };
  document.getElementById('logoutBtn').onclick = () => { auth.signOut().then(() => { localStorage.clear(); location.reload(); }); };
</script>
</body>
</html>




